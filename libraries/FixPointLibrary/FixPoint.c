//
// Created by Livio on 06.11.2019.
//This Class contains functions for calculation

#include "FixPoint.h"

#ifdef __cplusplus
extern "C"{
#endif

#ifdef USE_HARDWARE
#define COS(a) (long)(pgm_read_word(&cos_LUT[a]))
#define ERF(a) (long)(pgm_read_word(&erf_LUT[a]))

const FIXPOINT cos_LUT[90] PROGMEM = {
        65536,65526,65496,65446,65376,65287,65177,65048,64898,64729,64540,64332,64104,63856,63589,63303,62997,62672,62328,61966,61584,61183,60764,60326,59870,59396,58903,58393,57865,57319,56756,56175,55578,54963,54332,53684,53020,52339,51643,50931,50203,49461,48703,47930,47143,46341,45525,44695,43852,42995,42126,41243,40348,39441,38521,37590,36647,35693,34729,33754,32768,31772,30767,29753,28729,27697,26656,25607,24550,23486,22415,21336,20252,19161,18064,16962,15855,14742,13626,12505,11380,10252,9121,7987,6850,5712,4572,3430,2287,1144
};

const FIXPOINT erf_LUT[256] PROGMEM = {
        0,0,1,1,1,1,1,1,1,2,2,2,3,3,3,4,4,5,6,7,8,9,10,11,13,15,17,19,22,25,28,31,35,40,45,50,57,64,71,80,89,100,112,124,139,154,171,190,211,234,259,286,316,349,385,423,466,512,561,616,674,738,806,880,960,1046,1138,1238,1344,1459,1581,1712,1852,2001,2160,2330,2510,2701,2904,3119,3347,3587,3841,4109,4392,4689,5002,5330,5673,6034,6411,6805,7216,7645,8091,8556,9038,9539,10058,10596,11152,11726,12319,12929,13558,14204,14868,15549,16247,16961,17691,18437,19197,19971,20760,21561,22374,23198,24034,24878,25732,26594,27463,28338,29218,30102,30989,31878,32768,33658,34547,35434,36318,37198,38073,38942,39804,40658,41502,42338,43162,43975,44776,45565,46339,47099,47845,48575,49289,49987,50668,51332,51978,52607,53217,53810,54384,54940,55478,55997,56498,56980,57445,57891,58320,58731,59125,59502,59863,60206,60534,60847,61144,61427,61695,61949,62189,62417,62632,62835,63026,63206,63376,63535,63684,63824,63955,64077,64192,64298,64398,64490,64576,64656,64730,64798,64862,64920,64975,65024,65070,65113,65151,65187,65220,65250,65277,65302,65325,65346,65365,65382,65397,65412,65424,65436,65447,65456,65465,65472,65479,65486,65491,65496,65501,65505,65508,65511,65514,65517,65519,65521,65523,65525,65526,65527,65528,65529,65530,65531,65532,65532,65533,65533,65533,65534,65534,65534,65535,65535,65535,65535,65535,65535,65535,65536
};
#else
#define COS(a) cos_LUT[a]
#define ERF(a) erf_LUT[a]

const FIXPOINT cos_LUT[90] = {
        65536, 65526, 65496, 65446, 65376, 65287, 65177, 65048, 64898, 64729, 64540, 64332, 64104, 63856, 63589, 63303,
        62997, 62672, 62328, 61966, 61584, 61183, 60764, 60326, 59870, 59396, 58903, 58393, 57865, 57319, 56756, 56175,
        55578, 54963, 54332, 53684, 53020, 52339, 51643, 50931, 50203, 49461, 48703, 47930, 47143, 46341, 45525, 44695,
        43852, 42995, 42126, 41243, 40348, 39441, 38521, 37590, 36647, 35693, 34729, 33754, 32768, 31772, 30767, 29753,
        28729, 27697, 26656, 25607, 24550, 23486, 22415, 21336, 20252, 19161, 18064, 16962, 15855, 14742, 13626, 12505,
        11380, 10252, 9121, 7987, 6850, 5712, 4572, 3430, 2287, 1144
};

const FIXPOINT erf_LUT[256] = {
        0, 0, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 3, 3, 3, 4, 4, 5, 6, 7, 8, 9, 10, 11, 13, 15, 17, 19, 22, 25, 28, 31, 35,
        40, 45, 50, 57, 64, 71, 80, 89, 100, 112, 124, 139, 154, 171, 190, 211, 234, 259, 286, 316, 349, 385, 423, 466,
        512, 561, 616, 674, 738, 806, 880, 960, 1046, 1138, 1238, 1344, 1459, 1581, 1712, 1852, 2001, 2160, 2330, 2510,
        2701, 2904, 3119, 3347, 3587, 3841, 4109, 4392, 4689, 5002, 5330, 5673, 6034, 6411, 6805, 7216, 7645, 8091,
        8556, 9038, 9539, 10058, 10596, 11152, 11726, 12319, 12929, 13558, 14204, 14868, 15549, 16247, 16961, 17691,
        18437, 19197, 19971, 20760, 21561, 22374, 23198, 24034, 24878, 25732, 26594, 27463, 28338, 29218, 30102, 30989,
        31878, 32768, 33658, 34547, 35434, 36318, 37198, 38073, 38942, 39804, 40658, 41502, 42338, 43162, 43975, 44776,
        45565, 46339, 47099, 47845, 48575, 49289, 49987, 50668, 51332, 51978, 52607, 53217, 53810, 54384, 54940, 55478,
        55997, 56498, 56980, 57445, 57891, 58320, 58731, 59125, 59502, 59863, 60206, 60534, 60847, 61144, 61427, 61695,
        61949, 62189, 62417, 62632, 62835, 63026, 63206, 63376, 63535, 63684, 63824, 63955, 64077, 64192, 64298, 64398,
        64490, 64576, 64656, 64730, 64798, 64862, 64920, 64975, 65024, 65070, 65113, 65151, 65187, 65220, 65250, 65277,
        65302, 65325, 65346, 65365, 65382, 65397, 65412, 65424, 65436, 65447, 65456, 65465, 65472, 65479, 65486, 65491,
        65496, 65501, 65505, 65508, 65511, 65514, 65517, 65519, 65521, 65523, 65525, 65526, 65527, 65528, 65529, 65530,
        65531, 65532, 65532, 65533, 65533, 65533, 65534, 65534, 65534, 65535, 65535, 65535, 65535, 65535, 65535, 65535,
        65536
};
#endif


FIXPOINT fpCos(int angle) {
    if (angle >= 360) angle = angle % 360;
    if (angle < 90) return COS(angle);
    if (angle < 180) return -COS(179 - angle);
    if (angle < 270) return -COS(angle - 180);
    return COS(359 - angle);
}

FIXPOINT fpSin(int angle) {
    return fpCos(angle + 270);
}

FIXPOINT fpErf(int x) {
    if (x >= 256) x = x % 256;
    return ERF(x);
}

FIXPOINT intToFixed(int x) {
    if (x >= 0) return  (((U_FIXPOINT) (x) << FIXEDPOINT_SCALE));
    return  -(((U_FIXPOINT) (-x) << FIXEDPOINT_SCALE));
}

int fixedToInt(FIXPOINT x) {
    if (x >= 0) return ((int) ((U_FIXPOINT) (x) >> FIXEDPOINT_SCALE));
    return -((int) ((U_FIXPOINT) (-x) >> FIXEDPOINT_SCALE));
}

FIXPOINT fpMultiplication(FIXPOINT x, FIXPOINT y){
    if(x > 0 && y > 0) return (((unsigned long long) (x) * (y)) >> FIXEDPOINT_SCALE);
    if(y < 0) return -(((unsigned long long) (x) * (-y)) >> FIXEDPOINT_SCALE);
    if(x < 0) return -(((unsigned long long) (-x) * (y)) >> FIXEDPOINT_SCALE);
    return (((unsigned long long) (-x) * (-y)) >> FIXEDPOINT_SCALE);
}

FIXPOINT fpDivision(FIXPOINT x, FIXPOINT y){
    if(x > 0 && y > 0) return (((unsigned long long) (x) << FIXEDPOINT_SCALE) / (y));
    if(y < 0) return -(((unsigned long long) (x) << FIXEDPOINT_SCALE) / (-y));
    if(x < 0) return -((((unsigned long long) (-x) << FIXEDPOINT_SCALE) / (y)));
    return (((unsigned long long) (-x) << FIXEDPOINT_SCALE) / (-y));
}


#ifdef __cplusplus
}
#endif